<%- include('partials/header') %>

<div class="page-header">
  <h2>Message Templates</h2>
</div>

<div class="card">
  <div class="card-header">
    <span class="card-title">All Templates</span>
    <button class="btn btn-primary" onclick="showModal('addMessageModal')">Add Template</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Content Preview</th>
        <th>Landing Page</th>
        <th>Used</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% messages.forEach(msg => { %>
      <tr>
        <td><strong><%= msg.name %></strong></td>
        <td class="text-sm"><%= msg.content.substring(0, 60) %>...</td>
        <td class="text-sm text-muted"><%= msg.landingPageUrl ? 'Yes' : '-' %></td>
        <td><%= msg.usedCount %></td>
        <td>
          <span class="badge badge-<%= msg.isActive ? 'completed' : 'ignored' %>">
            <%= msg.isActive ? 'Active' : 'Inactive' %>
          </span>
        </td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick='editMessage("<%= msg._id %>", "<%= msg.name %>", `<%= msg.content.replace(/`/g, "\\`").replace(/"/g, "&quot;") %>`, "<%= msg.landingPageUrl || "" %>", <%= msg.isActive %>)'>Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteMessage('<%= msg._id %>')">Delete</button>
        </td>
      </tr>
      <% }) %>
      <% if (messages.length === 0) { %>
      <tr><td colspan="6" class="text-muted text-sm">No message templates yet</td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<div class="card mt-2">
  <div class="card-header">
    <span class="card-title">Template Variables</span>
  </div>
  <p class="text-sm" style="line-height: 1.8; padding: 10px 0;">
    Use these placeholders in your messages:<br>
    <code>{username}</code> - Lead's Instagram username<br>
    <code>{link}</code> - Tracked landing page link<br>
    <code>{category}</code> - Category name
  </p>
</div>

<!-- Add Message Modal -->
<div class="modal" id="addMessageModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add Message Template</h3>
      <button class="modal-close" onclick="hideModal('addMessageModal')">&times;</button>
    </div>
    <form id="addMessageForm">
      <div class="form-group">
        <label>Template Name</label>
        <input type="text" class="form-control" name="name" required placeholder="e.g., Welcome Message">
      </div>
      <div class="form-group">
        <label>Message Content</label>
        <textarea class="form-control" name="content" required rows="5"
          placeholder="Hey {username}! Check out our awesome stuff at {link}"></textarea>
      </div>
      <div class="form-group">
        <label>Landing Page URL (optional)</label>
        <input type="text" class="form-control" name="landingPageUrl" placeholder="https://yoursite.com/offer">
      </div>
      <button type="submit" class="btn btn-primary">Create Template</button>
    </form>
  </div>
</div>

<!-- Edit Message Modal -->
<div class="modal" id="editMessageModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Message Template</h3>
      <button class="modal-close" onclick="hideModal('editMessageModal')">&times;</button>
    </div>
    <form id="editMessageForm">
      <input type="hidden" name="id" id="editMessageId">
      <div class="form-group">
        <label>Template Name</label>
        <input type="text" class="form-control" name="name" id="editMessageName" required>
      </div>
      <div class="form-group">
        <label>Message Content</label>
        <textarea class="form-control" name="content" id="editMessageContent" required rows="5"></textarea>
      </div>
      <div class="form-group">
        <label>Landing Page URL</label>
        <input type="text" class="form-control" name="landingPageUrl" id="editMessageUrl">
      </div>
      <div class="form-group">
        <label><input type="checkbox" name="isActive" id="editMessageActive"> Active</label>
      </div>
      <button type="submit" class="btn btn-primary">Update Template</button>
    </form>
  </div>
</div>

<script>
  document.getElementById('addMessageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);

    const res = await apiCall('/api/messages', 'POST', data);
    if (res.success) {
      location.reload();
    } else {
      alert('Error: ' + res.error);
    }
  });

  function editMessage(id, name, content, url, isActive) {
    document.getElementById('editMessageId').value = id;
    document.getElementById('editMessageName').value = name;
    document.getElementById('editMessageContent').value = content;
    document.getElementById('editMessageUrl').value = url;
    document.getElementById('editMessageActive').checked = isActive;
    showModal('editMessageModal');
  }

  document.getElementById('editMessageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editMessageId').value;
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    data.isActive = document.getElementById('editMessageActive').checked;
    delete data.id;

    const res = await apiCall('/api/messages/' + id, 'PUT', data);
    if (res.success) {
      location.reload();
    } else {
      alert('Error: ' + res.error);
    }
  });

  async function deleteMessage(id) {
    if (!confirm('Delete this message template?')) return;
    const res = await apiCall('/api/messages/' + id, 'DELETE');
    if (res.success) {
      location.reload();
    } else {
      alert('Error: ' + res.error);
    }
  }
</script>

<%- include('partials/footer') %>
