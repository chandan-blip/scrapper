<%- include('partials/header') %>

<div class="page-header">
  <h2>Extraction</h2>
</div>

<div class="grid-2">
  <div class="card">
    <div class="card-header">
      <span class="card-title">Start New Extraction</span>
    </div>
    <form id="extractionForm">
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" name="categoryId" required>
          <option value="">Select Category</option>
          <% categories.forEach(cat => { %>
          <option value="<%= cat._id %>" data-url="<%= cat.sourceUrl %>" data-type="<%= cat.sourceType %>">
            <%= cat.name %>
          </option>
          <% }) %>
        </select>
      </div>
      <div class="form-group">
        <label>Source Type</label>
        <select class="form-control" name="sourceType" id="sourceType" required>
          <option value="followers">Followers</option>
          <option value="comments">Comments</option>
          <option value="likes">Likes</option>
        </select>
      </div>
      <div class="form-group">
        <label>Source URL</label>
        <input type="text" class="form-control" name="sourceUrl" id="sourceUrl" required
          placeholder="https://instagram.com/username/followers/">
      </div>
      <div class="form-group">
        <label>Iterations (scroll cycles)</label>
        <input type="number" class="form-control" name="iterations" value="25" min="1" max="100">
      </div>
      <div class="form-group">
        <label>Delay between scrolls (ms)</label>
        <input type="number" class="form-control" name="delay" value="2000" min="500" max="10000">
      </div>
      <button type="submit" class="btn btn-primary">Start Extraction</button>
    </form>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="card-title">Extraction Tips</span>
    </div>
    <ul style="padding-left: 20px; line-height: 1.8;">
      <li><strong>Followers:</strong> Use URL like <code>instagram.com/username/followers/</code></li>
      <li><strong>Comments:</strong> Use URL like <code>instagram.com/p/POST_ID/comments/</code></li>
      <li><strong>Likes:</strong> Use the post URL directly</li>
      <li>Make sure you're logged into Instagram in the extraction browser</li>
      <li>Adjust iterations based on how many users you want to extract</li>
      <li>Higher delay = slower but safer from rate limits</li>
    </ul>
  </div>
</div>

<div class="card mt-2">
  <div class="card-header">
    <span class="card-title">Recent Extraction Jobs</span>
    <button class="btn btn-secondary btn-sm" onclick="refreshJobs()">Refresh</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Category</th>
        <th>Type</th>
        <th>Status</th>
        <th>Extracted</th>
        <th>Saved</th>
        <th>Started</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="jobsTable">
      <% jobs.forEach(job => { %>
      <tr data-id="<%= job._id %>">
        <td><%= job.category ? job.category.name : 'N/A' %></td>
        <td><%= job.sourceType %></td>
        <td><span class="badge badge-<%= job.status %>"><%= job.status %></span></td>
        <td><%= job.totalExtracted %></td>
        <td><%= job.savedToDb ? job.totalSaved + ' saved' : 'Not saved' %></td>
        <td class="text-sm text-muted"><%= job.startedAt ? new Date(job.startedAt).toLocaleString() : '-' %></td>
        <td>
          <% if (job.status === 'running') { %>
          <button class="btn btn-danger btn-sm" onclick="cancelJob('<%= job._id %>')">Cancel</button>
          <% } else if (job.status === 'completed' && !job.savedToDb && job.totalExtracted > 0) { %>
          <button class="btn btn-success btn-sm" onclick="saveToDb('<%= job._id %>')">Save to DB</button>
          <button class="btn btn-secondary btn-sm" onclick="viewUsernames('<%= job._id %>')">View</button>
          <% } else if (job.savedToDb) { %>
          <span class="text-sm text-muted">Saved</span>
          <% } %>
        </td>
      </tr>
      <% }) %>
      <% if (jobs.length === 0) { %>
      <tr><td colspan="7" class="text-muted text-sm">No extraction jobs yet</td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- View Usernames Modal -->
<div class="modal" id="usernamesModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3>Extracted Usernames</h3>
      <button class="modal-close" onclick="hideModal('usernamesModal')">&times;</button>
    </div>
    <div id="usernamesList" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 13px; line-height: 1.6;"></div>
  </div>
</div>

<script>
  // Auto-fill from category selection
  document.querySelector('select[name="categoryId"]').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    if (option.dataset.url) {
      document.getElementById('sourceUrl').value = option.dataset.url;
    }
    if (option.dataset.type) {
      document.getElementById('sourceType').value = option.dataset.type;
    }
  });

  // Start extraction
  document.getElementById('extractionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {
      categoryId: formData.get('categoryId'),
      sourceType: formData.get('sourceType'),
      sourceUrl: formData.get('sourceUrl'),
      config: {
        iterations: parseInt(formData.get('iterations')),
        delay: parseInt(formData.get('delay'))
      }
    };

    const res = await apiCall('/api/extraction/start', 'POST', data);
    if (res.success) {
      alert('Extraction started! Job ID: ' + res.data._id);
      location.reload();
    } else {
      alert('Error: ' + res.error);
    }
  });

  async function cancelJob(id) {
    if (!confirm('Cancel this extraction job?')) return;
    const res = await apiCall('/api/extraction/' + id + '/cancel', 'POST');
    if (res.success) {
      location.reload();
    } else {
      alert('Error: ' + res.error);
    }
  }

  async function saveToDb(id) {
    if (!confirm('Save extracted usernames to database?')) return;
    const res = await apiCall('/api/extraction/' + id + '/save', 'POST');
    if (res.success) {
      alert(res.message);
      location.reload();
    } else {
      alert('Error: ' + res.error);
    }
  }

  async function viewUsernames(id) {
    const res = await apiCall('/api/extraction/' + id);
    if (res.success) {
      const usernames = res.data.extractedUsernames || [];
      document.getElementById('usernamesList').innerHTML = usernames.map((u, i) =>
        `${i + 1}. @${u}`
      ).join('<br>') || 'No usernames';
      showModal('usernamesModal');
    }
  }

  async function refreshJobs() {
    location.reload();
  }

  // Auto-refresh running jobs
  setInterval(async () => {
    const runningJobs = document.querySelectorAll('.badge-running');
    if (runningJobs.length > 0) {
      const res = await apiCall('/api/extractions');
      if (res.success) {
        res.data.forEach(job => {
          const row = document.querySelector(`tr[data-id="${job._id}"]`);
          if (row) {
            const statusBadge = row.querySelector('.badge');
            if (statusBadge) {
              statusBadge.className = 'badge badge-' + job.status;
              statusBadge.textContent = job.status;
            }
            const cells = row.querySelectorAll('td');
            if (cells[3]) cells[3].textContent = job.totalExtracted;
          }
        });
      }
    }
  }, 5000);
</script>

<%- include('partials/footer') %>
